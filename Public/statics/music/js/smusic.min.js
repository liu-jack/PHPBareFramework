!(function(e){function h(m){d("title").innerHTML=m.innerHTML.replace(/<\/?.+?>/g,"")+" - HTML5音乐播放器";var n=document.getElementsByClassName("m-music-list-wrap")[0];var o=document.getElementsByClassName("f-toe")[0].offsetTop;n.scrollTop=m.offsetTop-o}function b(n,m){if(c(n,m)==false){n.className+=" "+m}}function c(n,m){return !!n.className.match(new RegExp("(\\s|^)"+m+"(\\s|$)"))}function k(n,m){var o=n.className;if(c(n,m)){o=o.replace(new RegExp("(\\s|^)"+m+"(\\s|$)")," ");o=o.replace(/(^\s*)|(\s*$)/g,"");n.className=o}}function i(n,m){if(c(n,m)){k(n,m)}else{b(n,m)}}function d(m){return document.querySelector(m)}function a(o,m){for(var n in m){if(m.hasOwnProperty(n)){o[n]=m[n]}}return o}function j(o){var m,p,n,q="";m=String(parseInt(o/3600,10));p=String(parseInt((o%3600)/60,10));n=String(parseInt(o%60,10));if(m!="0"){if(m.length==1){m="0"+m}q+=(m+":")}if(p.length==1){p="0"+p}q+=(p+":");if(n.length==1){n="0"+n}q+=n;return q}function f(m,n){if(!m){return false}var o=new XMLHttpRequest();o.onreadystatechange=function(){if(o.readyState==4){var p=o.status;if((p>=200&&p<300)||p==304){(n&&typeof n=="function")&&n(o.responseText);return true}else{return new Error("ajax请求失败")}}};o.open("GET",m,true);o.setRequestHeader("X-Requested-With","XMLHttpRequest");o.send();return true}var g=null;function l(m){var n=this.config;this.config=a(n,m);this.musicList=this.config.musicList||[];this.musicLength=this.musicList.length;if(!this.musicLength||!d("body")){this.musicDom.listWrap.innerHTML="<p>暂无播放记录...</p>"}this.audioDom=null;this.init()}l.prototype={config:{musicList:[],defaultVolume:0.7,defaultIndex:0,autoPlay:false,defaultMode:1,callback:function(m){}},createListDom:function(){var n=0,m="<ul>";for(n;n<this.musicLength;n++){m+='<li class="f-toe"><strong>'+this.musicList[n]["title"]+"</strong> -- <small>"+this.musicList[n]["singer"]+"</small></li>"}m+="</ul>";this.musicDom.listWrap.innerHTML=m},setBuffer:function(o,n){var m=n.parentNode.offsetWidth;g=setInterval(function(){var q=o.buffered.length;if(q>0&&o.buffered!=undefined){var p=(o.buffered.end(q-1)/o.duration)*m;n.style.width=p+"px";if(Math.abs(o.duration-o.buffered.end(q-1))<1){n.style.width=m+"px";clearInterval(g)}}},1000)},resetPlayer:function(m){(m>=(this.musicLength-1))&&(m=(this.musicLength-1));(m<=0)&&(m=0);this.currentMusic=m;var p=this.musicList[m],q=this;var o=function(){return q.setBuffer(this,q.musicDom.bufferProcess)};this.audioDom.removeEventListener("canplay",o,false);clearInterval(g);this.musicDom.bufferProcess.style.width=0+"px";this.musicDom.curProcess.style.width=0+"px";this.audioDom.src=p.src;this.musicDom.cover.innerHTML='<img src="'+p.cover+'" title="'+p.title+" -- "+p.singer+'">';this.musicDom.title.innerHTML="<strong>"+p.title+"</strong><small>"+p.singer+"</small>";q.musicDom.lyricWrap.innerHTML='<li class="eof">正在加载歌词...</li>';q.musicDom.lyricWrap.style.marginTop=0+"px";q.musicDom.lyricWrap.scrollTop=0;this.getLyric(m);var s=document.querySelectorAll(".m-music-list-wrap li"),n=0;for(n;n<this.musicLength;n++){if(n==m){b(s[n],"current");h(s[n])}else{k(s[n],"current")}}this.audioDom.addEventListener("canplay",o,false);if(this.config.autoPlay){this.play()}else{this.pause()}var r=p;r.index=m;typeof this.config.callback=="function"&&this.config.callback(r)},setVolume:function(m){var n=this.musicDom.volume,o=n.volumeEventer.offsetHeight||50;if(m<=0){m=0}if(m>=1){m=1}this.audioDom.volume=m;var p=o*m;n.volumeCurrent.style.height=p+"px";n.volumeCtrlBar.style.bottom=p+"px";n.volumeProcess.setAttribute("data-volume",m);if(m==0){b(n.volumeControl,"muted");this.audioDom.muted=true}else{k(n.volumeControl,"muted");this.audioDom.muted=false}},initPlay:function(){var m=this.config.defaultIndex;if(this.playMode==2){m=this.getRandomIndex()}this.setVolume(this.config.defaultVolume);this.audioDom.load();this.resetPlayer(m)},play:function(){var m=this.musicDom.button.ctrl;this.audioDom.play();k(m,"paused");b(m,"play");m.setAttribute("title","暂停");k(this.musicDom.cover,"paused");b(this.musicDom.cover,"play")},pause:function(){var m=this.musicDom.button.ctrl;this.audioDom.pause();k(m,"play");b(m,"paused");m.setAttribute("title","播放");k(this.musicDom.cover,"play");b(this.musicDom.cover,"paused")},getRandomIndex:function(){var n=this.currentMusic,m=this.musicLength,q=0,p=[];for(q;q<m;q++){if(q!=n){p.push(q)}}var o=parseInt(Math.random()*p.length);return p[o]},playByMode:function(p){var q=this.playMode,n=this.currentMusic,m=this.musicLength,o=n;if(q==1){if(p=="prev"){o=((n<=m-1)&&(n>0))?(n-1):(m-1)}else{if(p=="next"||p=="ended"){o=(n>=m-1)?0:(n+1)}}}else{if(q==2){o=this.getRandomIndex()}else{if(q==3){if(p=="prev"){o=((n<=m-1)&&(n>0))?(n-1):(m-1)}else{if(p=="next"){o=(n>=m-1)?0:(n+1)}else{o=n}}}}}this.resetPlayer(o)},action:function(){var q=this,m=this.musicDom.volume,o=this.musicDom.button;this.audioDom.addEventListener("timeupdate",function(){var x=this;if(!isNaN(x.duration)){var u=j(x.currentTime),z=j(x.duration);var s=(x.currentTime/x.duration)*(q.musicDom.bufferProcess.parentNode.offsetWidth);q.musicDom.time.innerHTML=""+u+"/"+z+"";q.musicDom.curProcess.style.width=s+"px";var t=parseInt(x.currentTime*1000);var y=q.musicDom.lyricWrap.querySelectorAll(".u-lyric"),D=y.length,w=0;if(D>1){for(;w<D;w++){var A=y[w];if(A){var C=parseFloat(A.getAttribute("data-time"));if(t>=C){var B=(w-1)*30;q.musicDom.lyricWrap.style.marginTop=-B+"px";for(var v=0;v<D;v++){y[v]&&k(y[v],"current")}b(A,"current")}}}}}},false);this.audioDom.addEventListener("ended",function(){q.playByMode("ended")},false);m.volumeControl.addEventListener("click",function(s){s=s||window.event;s.stopPropagation();if(c(m.volumeProcess,"show")){i(this,"muted");c(this,"muted")?(q.audioDom.muted=true):(q.audioDom.muted=false)}else{b(m.volumeProcess,"show")}},false);document.addEventListener("click",function(s){s=s||window.event;s.stopPropagation();var t=s.target||s.srcElement;if((t.parentNode!==m.volumeProcess)&&t.parentNode!==d(".grid-music-container .u-volume")){k(m.volumeProcess,"show")}},false);m.volumeEventer.addEventListener("click",function(u){u=u||window.event;u.stopPropagation();var t=this.offsetHeight,v=u.offsetY,s=(t-v)/t;q.setVolume(s)},false);var r=document.querySelectorAll(".m-music-list-wrap li"),n=0;for(n;n<this.musicLength;n++){!(function(s){r[s].addEventListener("click",function(){q.resetPlayer(s)},false)}(n))}o.ctrl.addEventListener("click",function(){if(c(this,"play")){q.pause()}else{q.play()}},false);o.prev.addEventListener("click",function(){q.playByMode("prev")},false);o.next.addEventListener("click",function(){q.playByMode("next")},false);o.listCircular.addEventListener("click",function(){b(this,"current");k(o.singleCircular,"current");k(o.randomPlay,"current");q.playMode=1});o.randomPlay.addEventListener("click",function(){b(this,"current");k(o.singleCircular,"current");k(o.listCircular,"current");q.playMode=2});o.singleCircular.addEventListener("click",function(){b(this,"current");k(o.listCircular,"current");k(o.randomPlay,"current");q.playMode=3});var p=this.musicDom.curProcess.parentNode;p.addEventListener("click",function(v){v=v||window.event;var u=this.getBoundingClientRect().left,s=this.offsetWidth;var t=Math.min(s,Math.abs(v.clientX-u));if(q.audioDom.currentTime&&q.audioDom.duration){q.audioDom.currentTime=parseInt((t/s)*(q.audioDom.duration));q.play()}})},getLyric:function(n){if(this.lyricCache[n]){this.renderLyric(this.lyricCache[n])}else{var m=this.musicList[n]["lyric"],o=this;if(m){f(m,function(p){o.lyricCache[n]=p?p:null;o.renderLyric(p)})}else{this.lyricCache[n]=null;o.renderLyric(null)}}},parseLyric:function(B){if(!B){return B}var x=[];var w=B.split("[");w.shift();for(var u=0;u<w.length;u++){var n=w[u].split("]");if(n.length>=2&&n[1]!=""){var q=n[0].split(":"),A=0;if(q.length>=2){var y=q[0].split(""),m=0;for(var r=0;r<y.length;r++){if(Number(y[r])>0){m+=y[r]*Math.pow(10,y.length-r-1)}}A+=m*60;var p=q[1].split("."),v=p[0].split(""),z=0;for(var s=0;s<v.length;s++){if(Number(v[s])>0){z+=v[s]*Math.pow(10,v.length-s-1)}}A+=Number(z+"."+p[1])}if(A&&typeof A=="number"){x.push({time:parseInt(A*1000),content:n[1]})}}}return x},renderLyric:function(u){u=this.parseLyric(u);var s=this,n=s.musicDom.lyricWrap,r="",q,o=0;q=u?u.length:0;if(u&&q){for(o;o<q;o++){var p=u[o];var m=p.time,t=p.content.trim();t=t?t:"--- music ---";r+='<li class="u-lyric f-toe" data-time="'+m+'">'+t+"</li>"}r&&(r+='<li class="u-lyric">www.29fh.com</li>')}else{r='<li class="eof">暂无歌词...</li>'}n.style.marginTop=0+"px";n.screenTop=0;n.innerHTML=r},init:function(){this.musicDom={music:d(".grid-music-container"),cover:d(".grid-music-container .u-cover"),title:d(".grid-music-container .u-music-title"),curProcess:d(".grid-music-container .current-process"),bufferProcess:d(".grid-music-container .buffer-process"),time:d(".grid-music-container .u-time"),listWrap:d(".grid-music-container .m-music-list-wrap"),lyricWrap:d(".grid-music-container .js-music-lyric-content"),volume:{volumeProcess:d(".grid-music-container .volume-process"),volumeCurrent:d(".grid-music-container .volume-current"),volumeCtrlBar:d(".grid-music-container .volume-bar"),volumeEventer:d(".grid-music-container .volume-event"),volumeControl:d(".grid-music-container .volume-control")},button:{ctrl:d(".grid-music-container .ctrl-play"),prev:d(".grid-music-container .prev"),next:d(".grid-music-container .next"),listCircular:d(".grid-music-container .mode-list"),randomPlay:d(".grid-music-container .mode-random"),singleCircular:d(".grid-music-container .mode-single")}};this.currentMusic=this.config.defaultIndex||0;this.playMode=this.config.defaultMode||1;this.lyricCache={};this.audioDom=document.createElement("audio");this.createListDom();this.initPlay();this.action()}};e=e||window;e.SMusic=function(m){return new l(m)}})(window);