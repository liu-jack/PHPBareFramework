!function(t){function e(t){s("title").innerHTML=t.innerHTML.replace(/<\/?.+?>/g,"")+" - HTML5音乐播放器";var e=document.getElementsByClassName("m-music-list-wrap")[0],i=document.getElementsByClassName("f-toe")[0].offsetTop;e.scrollTop=t.offsetTop-i-30}function i(t,e){0==r(t,e)&&(t.className+=" "+e)}function r(t,e){return!!t.className.match(new RegExp("(\\s|^)"+e+"(\\s|$)"))}function n(t,e){var i=t.className;r(t,e)&&(i=(i=i.replace(new RegExp("(\\s|^)"+e+"(\\s|$)")," ")).replace(/(^\s*)|(\s*$)/g,""),t.className=i)}function s(t){return document.querySelector(t)}function o(t){var e,i,r,n="";return e=String(parseInt(t/3600,10)),i=String(parseInt(t%3600/60,10)),r=String(parseInt(t%60,10)),"0"!=e&&(1==e.length&&(e="0"+e),n+=e+":"),1==i.length&&(i="0"+i),n+=i+":",1==r.length&&(r="0"+r),n+=r}var c=null;function u(t){var e=this.config;this.config=function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t}(e,t),this.musicList=this.config.musicList||[],this.musicLength=this.musicList.length,this.musicLength&&s("body")||(this.musicDom.listWrap.innerHTML="<p>暂无播放记录...</p>"),this.audioDom=null,this.init()}u.prototype={config:{musicList:[],defaultVolume:.7,defaultIndex:0,autoPlay:!1,defaultMode:1,callback:function(t){}},createListDom:function(){for(var t=0,e="<ul>";t<this.musicLength;t++)e+='<li class="f-toe"><strong>'+this.musicList[t].title+"</strong> -- <small>"+this.musicList[t].singer+"</small></li>";e+="</ul>",this.musicDom.listWrap.innerHTML=e},setBuffer:function(t,e){var i=e.parentNode.offsetWidth;c=setInterval(function(){var r=t.buffered.length;if(r>0&&null!=t.buffered){var n=t.buffered.end(r-1)/t.duration*i;e.style.width=n+"px",Math.abs(t.duration-t.buffered.end(r-1))<1&&(e.style.width=i+"px",clearInterval(c))}},1e3)},resetPlayer:function(t){t>=this.musicLength-1&&(t=this.musicLength-1),t<=0&&(t=0),this.currentMusic=t;var r=this.musicList[t],s=this,o=function(){return s.setBuffer(this,s.musicDom.bufferProcess)};this.audioDom.removeEventListener("canplay",o,!1),clearInterval(c),this.musicDom.bufferProcess.style.width="0px",this.musicDom.curProcess.style.width="0px",this.audioDom.src=r.src,this.musicDom.cover.innerHTML='<img src="'+r.cover+'" title="'+r.title+" -- "+r.singer+'">',this.musicDom.title.innerHTML="<strong>"+r.title+"</strong><small>"+r.singer+"</small>",s.musicDom.lyricWrap.innerHTML='<li class="eof">正在加载歌词...</li>',s.musicDom.lyricWrap.style.marginTop="0px",s.musicDom.lyricWrap.scrollTop=0,this.getLyric(t);for(var u=document.querySelectorAll(".m-music-list-wrap li"),a=0;a<this.musicLength;a++)a==t?(i(u[a],"current"),e(u[a])):n(u[a],"current");this.audioDom.addEventListener("canplay",o,!1),this.config.autoPlay?this.play():this.pause();var l=r;l.index=t,"function"==typeof this.config.callback&&this.config.callback(l)},setVolume:function(t){var e=this.musicDom.volume,r=e.volumeEventer.offsetHeight||50;t<=0&&(t=0),t>=1&&(t=1),localStorage.setItem("smusic_volume",t),this.audioDom.volume=t;var s=r*t;e.volumeCurrent.style.height=s+"px",e.volumeCtrlBar.style.bottom=s+"px",e.volumeProcess.setAttribute("data-volume",t),0==t?(i(e.volumeControl,"muted"),this.audioDom.muted=!0):(n(e.volumeControl,"muted"),this.audioDom.muted=!1)},initPlay:function(){var t=this.config.defaultIndex;2==this.playMode&&(t=this.getRandomIndex());var e=localStorage.getItem("smusic_volume");e||(e=this.config.defaultVolume),this.setVolume(e),this.audioDom.load(),this.resetPlayer(t)},play:function(){var t=this.musicDom.button.ctrl;this.audioDom.play(),n(t,"paused"),i(t,"play"),t.setAttribute("title","暂停"),n(this.musicDom.cover,"paused"),i(this.musicDom.cover,"play")},pause:function(){var t=this.musicDom.button.ctrl;this.audioDom.pause(),n(t,"play"),i(t,"paused"),t.setAttribute("title","播放"),n(this.musicDom.cover,"play"),i(this.musicDom.cover,"paused")},getRandomIndex:function(){for(var t=this.currentMusic,e=this.musicLength,i=0,r=[];i<e;i++)i!=t&&r.push(i);return r[parseInt(Math.random()*r.length)]},playByMode:function(t){var e=this.playMode,i=this.currentMusic,r=this.musicLength,n=i;1==e?"prev"==t?n=i<=r-1&&i>0?i-1:r-1:"next"!=t&&"ended"!=t||(n=i>=r-1?0:i+1):2==e?n=this.getRandomIndex():3==e&&(n="prev"==t?i<=r-1&&i>0?i-1:r-1:"next"==t?i>=r-1?0:i+1:i),this.resetPlayer(n)},action:function(){var t=this,e=this.musicDom.volume,c=this.musicDom.button;this.audioDom.addEventListener("timeupdate",function(){if(!isNaN(this.duration)){var e=o(this.currentTime),r=o(this.duration),s=this.currentTime/this.duration*t.musicDom.bufferProcess.parentNode.offsetWidth;t.musicDom.time.innerHTML=e+"/"+r,t.musicDom.curProcess.style.width=s+"px";var c=parseInt(1e3*this.currentTime),u=t.musicDom.lyricWrap.querySelectorAll(".u-lyric"),a=u.length,l=0;if(a>1)for(;l<a;l++){var m=u[l];if(m)if(c>=parseFloat(m.getAttribute("data-time"))){var d=30*(l-1);t.musicDom.lyricWrap.style.marginTop=-d+"px";for(var h=0;h<a;h++)u[h]&&n(u[h],"current");i(m,"current")}}}},!1),this.audioDom.addEventListener("ended",function(){t.playByMode("ended")},!1),e.volumeControl.addEventListener("click",function(s){var o,c;(s=s||window.event).stopPropagation(),r(e.volumeProcess,"show")?(r(o=this,c="muted")?n(o,c):i(o,c),r(this,"muted")?t.audioDom.muted=!0:t.audioDom.muted=!1):i(e.volumeProcess,"show")},!1),document.addEventListener("click",function(t){(t=t||window.event).stopPropagation();var i=t.target||t.srcElement;i.parentNode!==e.volumeProcess&&i.parentNode!==s(".grid-music-container .u-volume")&&n(e.volumeProcess,"show")},!1),e.volumeEventer.addEventListener("click",function(e){(e=e||window.event).stopPropagation();var i=this.offsetHeight,r=(i-e.offsetY)/i;t.setVolume(r)},!1);for(var u=document.querySelectorAll(".m-music-list-wrap li"),a=0;a<this.musicLength;a++)!function(e){u[e].addEventListener("click",function(){t.resetPlayer(e)},!1)}(a);c.ctrl.addEventListener("click",function(){r(this,"play")?t.pause():t.play()},!1),c.prev.addEventListener("click",function(){t.playByMode("prev")},!1),c.next.addEventListener("click",function(){t.playByMode("next")},!1),c.listCircular.addEventListener("click",function(){i(this,"current"),n(c.singleCircular,"current"),n(c.randomPlay,"current"),t.playMode=1}),c.randomPlay.addEventListener("click",function(){i(this,"current"),n(c.singleCircular,"current"),n(c.listCircular,"current"),t.playMode=2}),c.singleCircular.addEventListener("click",function(){i(this,"current"),n(c.listCircular,"current"),n(c.randomPlay,"current"),t.playMode=3}),this.musicDom.curProcess.parentNode.addEventListener("click",function(e){e=e||window.event;var i=this.getBoundingClientRect().left,r=this.offsetWidth,n=Math.min(r,Math.abs(e.clientX-i));t.audioDom.currentTime&&t.audioDom.duration&&(t.audioDom.currentTime=parseInt(n/r*t.audioDom.duration),t.play())})},getLyric:function(t){if(this.lyricCache[t])this.renderLyric(this.lyricCache[t]);else{var e=this.musicList[t].lyric,i=this;e?function(t,e){if(!t)return!1;var i=new XMLHttpRequest;i.onreadystatechange=function(){if(4==i.readyState){var t=i.status;return t>=200&&t<300||304==t?(e&&"function"==typeof e&&e(i.responseText),!0):new Error("ajax请求失败")}},i.open("GET",t,!0),i.setRequestHeader("X-Requested-With","XMLHttpRequest"),i.send()}(e,function(e){i.lyricCache[t]=e||null,i.renderLyric(e)}):(this.lyricCache[t]=null,i.renderLyric(null))}},parseLyric:function(t){if(!t)return t;var e=[],i=t.split("[");i.shift();for(var r=0;r<i.length;r++){var n=i[r].split("]");if(n.length>=2&&""!=n[1]){var s=n[0].split(":"),o=0;if(s.length>=2){for(var c=s[0].split(""),u=0,a=0;a<c.length;a++)Number(c[a])>0&&(u+=c[a]*Math.pow(10,c.length-a-1));o+=60*u;for(var l=s[1].split("."),m=l[0].split(""),d=0,h=0;h<m.length;h++)Number(m[h])>0&&(d+=m[h]*Math.pow(10,m.length-h-1));o+=Number(d+"."+l[1])}o&&"number"==typeof o&&e.push({time:parseInt(1e3*o),content:n[1]})}}return e},renderLyric:function(t){t=this.parseLyric(t);var e,i=this.musicDom.lyricWrap,r="",n=0;if(e=t?t.length:0,t&&e){for(;n<e;n++){var s=t[n],o=s.time,c=s.content.trim();r+='<li class="u-lyric f-toe" data-time="'+o+'">'+(c=c||"--- music ---")+"</li>"}r&&(r+='<li class="u-lyric">www.29fh.com</li>')}else r='<li class="eof">暂无歌词...</li>';i.style.marginTop="0px",i.screenTop=0,i.innerHTML=r},init:function(){this.musicDom={music:s(".grid-music-container"),cover:s(".grid-music-container .u-cover"),title:s(".grid-music-container .u-music-title"),curProcess:s(".grid-music-container .current-process"),bufferProcess:s(".grid-music-container .buffer-process"),time:s(".grid-music-container .u-time"),listWrap:s(".grid-music-container .m-music-list-wrap"),lyricWrap:s(".grid-music-container .js-music-lyric-content"),volume:{volumeProcess:s(".grid-music-container .volume-process"),volumeCurrent:s(".grid-music-container .volume-current"),volumeCtrlBar:s(".grid-music-container .volume-bar"),volumeEventer:s(".grid-music-container .volume-event"),volumeControl:s(".grid-music-container .volume-control")},button:{ctrl:s(".grid-music-container .ctrl-play"),prev:s(".grid-music-container .prev"),next:s(".grid-music-container .next"),listCircular:s(".grid-music-container .mode-list"),randomPlay:s(".grid-music-container .mode-random"),singleCircular:s(".grid-music-container .mode-single")}},this.currentMusic=this.config.defaultIndex||0,this.playMode=this.config.defaultMode||1,this.lyricCache={},this.audioDom=document.createElement("audio"),this.createListDom(),this.initPlay(),this.action()}},(t=t||window).SMusic=function(t){return new u(t)}}(window);