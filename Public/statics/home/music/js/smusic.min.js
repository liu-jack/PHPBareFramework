!(function(win){function changeMusic(element){$("title").innerHTML=element.innerHTML.replace(/<\/?.+?>/g,"")+" - HTML5音乐播放器";var musicBox=document.getElementsByClassName("m-music-list-wrap")[0];var musicTop=document.getElementsByClassName("f-toe")[0].offsetTop;musicBox.scrollTop=element.offsetTop-musicTop-30}function addClass(element,className){if(hasClass(element,className)==false){element.className+=" "+className}}function hasClass(element,className){return !!element.className.match(new RegExp("(\\s|^)"+className+"(\\s|$)"))}function removeClass(element,className){var currentClass=element.className;if(hasClass(element,className)){currentClass=currentClass.replace(new RegExp("(\\s|^)"+className+"(\\s|$)")," ");currentClass=currentClass.replace(/(^\s*)|(\s*$)/g,"");element.className=currentClass}}function toggleClass(element,className){if(hasClass(element,className)){removeClass(element,className)}else{addClass(element,className)}}function $(element){return document.querySelector(element)}function extend(target,source){for(var p in source){if(source.hasOwnProperty(p)){target[p]=source[p]}}return target}function calcTime(time){var hour,minute,second,timer="";hour=String(parseInt(time/3600,10));minute=String(parseInt((time%3600)/60,10));second=String(parseInt(time%60,10));if(hour!="0"){if(hour.length==1){hour="0"+hour}timer+=(hour+":")}if(minute.length==1){minute="0"+minute}timer+=(minute+":");if(second.length==1){second="0"+second}timer+=second;return timer}function ajax(url,callback){if(!url){return false}var xhr=new XMLHttpRequest();xhr.onreadystatechange=function(){if(xhr.readyState==4){var status=xhr.status;if((status>=200&&status<300)||status==304){(callback&&typeof callback=="function")&&callback(xhr.responseText);return true}else{return new Error("ajax请求失败")}}};xhr.open("GET",url,true);xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");xhr.send();return true}var bufferTimer=null;function SmohanMusic(config){var defaults=this.config;this.config=extend(defaults,config);this.musicList=this.config.musicList||[];this.musicLength=this.musicList.length;if(!this.musicLength||!$("body")){this.musicDom.listWrap.innerHTML="<p>暂无播放记录...</p>"}this.audioDom=null;this.init()}SmohanMusic.prototype={config:{musicList:[],defaultVolume:0.7,defaultIndex:0,autoPlay:false,defaultMode:1,callback:function(obj){}},createListDom:function(){var i=0,ul="<ul>";for(i;i<this.musicLength;i++){ul+='<li class="f-toe"><strong>'+this.musicList[i]["title"]+"</strong> -- <small>"+this.musicList[i]["singer"]+"</small></li>"}ul+="</ul>";this.musicDom.listWrap.innerHTML=ul},setBuffer:function(audio,bufferDom){var w=bufferDom.parentNode.offsetWidth;bufferTimer=setInterval(function(){var buffer=audio.buffered.length;if(buffer>0&&audio.buffered!=undefined){var bufferWidth=(audio.buffered.end(buffer-1)/audio.duration)*w;bufferDom.style.width=bufferWidth+"px";if(Math.abs(audio.duration-audio.buffered.end(buffer-1))<1){bufferDom.style.width=w+"px";clearInterval(bufferTimer)}}},1000)},resetPlayer:function(idx){(idx>=(this.musicLength-1))&&(idx=(this.musicLength-1));(idx<=0)&&(idx=0);this.currentMusic=idx;var nowMusic=this.musicList[idx],me=this;var tempBuffer=function(){return me.setBuffer(this,me.musicDom.bufferProcess)};this.audioDom.removeEventListener("canplay",tempBuffer,false);clearInterval(bufferTimer);this.musicDom.bufferProcess.style.width=0+"px";this.musicDom.curProcess.style.width=0+"px";this.audioDom.src=nowMusic.src;this.musicDom.cover.innerHTML='<img src="'+nowMusic.cover+'" title="'+nowMusic.title+" -- "+nowMusic.singer+'">';this.musicDom.title.innerHTML="<strong>"+nowMusic.title+"</strong><small>"+nowMusic.singer+"</small>";me.musicDom["lyricWrap"].innerHTML='<li class="eof">正在加载歌词...</li>';me.musicDom["lyricWrap"].style.marginTop=0+"px";me.musicDom["lyricWrap"].scrollTop=0;this.getLyric(idx);var playlist=document.querySelectorAll(".m-music-list-wrap li"),i=0;for(i;i<this.musicLength;i++){if(i==idx){addClass(playlist[i],"current");changeMusic(playlist[i])}else{removeClass(playlist[i],"current")}}this.audioDom.addEventListener("canplay",tempBuffer,false);if(this.config.autoPlay){this.play()}else{this.pause()}var _callback=nowMusic;_callback.index=idx;typeof this.config.callback=="function"&&this.config.callback(_callback)},setVolume:function(volume){var v=this.musicDom.volume,h=v.volumeEventer.offsetHeight||50;if(volume<=0){volume=0}if(volume>=1){volume=1}localStorage.setItem("smusic_volume",volume);this.audioDom.volume=volume;var currentHeight=h*volume;v.volumeCurrent.style.height=currentHeight+"px";v.volumeCtrlBar.style.bottom=currentHeight+"px";v.volumeProcess.setAttribute("data-volume",volume);if(volume==0){addClass(v.volumeControl,"muted");this.audioDom.muted=true}else{removeClass(v.volumeControl,"muted");this.audioDom.muted=false}},initPlay:function(){var idx=this.config.defaultIndex;if(this.playMode==2){idx=this.getRandomIndex()}var volume=localStorage.getItem("smusic_volume");if(!volume){volume=this.config.defaultVolume
    }this.setVolume(volume);this.audioDom.load();this.resetPlayer(idx)},play:function(){var ctrl=this.musicDom.button.ctrl;this.audioDom.play();removeClass(ctrl,"paused");addClass(ctrl,"play");ctrl.setAttribute("title","暂停");removeClass(this.musicDom.cover,"paused");addClass(this.musicDom.cover,"play")},pause:function(){var ctrl=this.musicDom.button.ctrl;this.audioDom.pause();removeClass(ctrl,"play");addClass(ctrl,"paused");ctrl.setAttribute("title","播放");removeClass(this.musicDom.cover,"play");addClass(this.musicDom.cover,"paused")},getRandomIndex:function(){var idx=this.currentMusic,len=this.musicLength,i=0,temp=[];for(i;i<len;i++){if(i!=idx){temp.push(i)}}var random=parseInt(Math.random()*temp.length);return temp[random]},playByMode:function(type){var modes=this.playMode,idx=this.currentMusic,len=this.musicLength,index=idx;if(modes==1){if(type=="prev"){index=((idx<=len-1)&&(idx>0))?(idx-1):(len-1)}else{if(type=="next"||type=="ended"){index=(idx>=len-1)?0:(idx+1)}}}else{if(modes==2){index=this.getRandomIndex()}else{if(modes==3){if(type=="prev"){index=((idx<=len-1)&&(idx>0))?(idx-1):(len-1)}else{if(type=="next"){index=(idx>=len-1)?0:(idx+1)}else{index=idx}}}}}this.resetPlayer(index)},action:function(){var me=this,v=this.musicDom.volume,btn=this.musicDom.button;this.audioDom.addEventListener("timeupdate",function(){var audio=this;if(!isNaN(audio.duration)){var surplusTime=calcTime(audio.currentTime),totalTime=calcTime(audio.duration);var currentProcess=(audio.currentTime/audio.duration)*(me.musicDom.bufferProcess.parentNode.offsetWidth);me.musicDom.time.innerHTML=""+surplusTime+"/"+totalTime+"";me.musicDom.curProcess.style.width=currentProcess+"px";var curTime=parseInt(audio.currentTime*1000);var lyrics=me.musicDom["lyricWrap"].querySelectorAll(".u-lyric"),sizes=lyrics.length,i=0;if(sizes>1){for(;i<sizes;i++){var lyl=lyrics[i];if(lyl){var _time=parseFloat(lyl.getAttribute("data-time"));if(curTime>=_time){var top=(i-1)*30;me.musicDom["lyricWrap"].style.marginTop=-top+"px";for(var j=0;j<sizes;j++){lyrics[j]&&removeClass(lyrics[j],"current")}addClass(lyl,"current")}}}}}},false);this.audioDom.addEventListener("ended",function(){me.playByMode("ended")},false);v.volumeControl.addEventListener("click",function(event){event=event||window.event;event.stopPropagation();if(hasClass(v.volumeProcess,"show")){toggleClass(this,"muted");hasClass(this,"muted")?(me.audioDom.muted=true):(me.audioDom.muted=false)}else{addClass(v.volumeProcess,"show")}},false);document.addEventListener("click",function(event){event=event||window.event;event.stopPropagation();var target=event.target||event.srcElement;if((target.parentNode!==v.volumeProcess)&&target.parentNode!==$(".grid-music-container .u-volume")){removeClass(v.volumeProcess,"show")}},false);v.volumeEventer.addEventListener("click",function(event){event=event||window.event;event.stopPropagation();var h=this.offsetHeight,y=event.offsetY,volume=(h-y)/h;me.setVolume(volume)},false);var playlist=document.querySelectorAll(".m-music-list-wrap li"),i=0;for(i;i<this.musicLength;i++){!(function(i){playlist[i].addEventListener("click",function(){me.resetPlayer(i)},false)}(i))}btn.ctrl.addEventListener("click",function(){if(hasClass(this,"play")){me.pause()}else{me.play()}},false);btn.prev.addEventListener("click",function(){me.playByMode("prev")},false);btn.next.addEventListener("click",function(){me.playByMode("next")},false);btn.listCircular.addEventListener("click",function(){addClass(this,"current");removeClass(btn.singleCircular,"current");removeClass(btn.randomPlay,"current");me.playMode=1});btn.randomPlay.addEventListener("click",function(){addClass(this,"current");removeClass(btn.singleCircular,"current");removeClass(btn.listCircular,"current");me.playMode=2});btn.singleCircular.addEventListener("click",function(){addClass(this,"current");removeClass(btn.listCircular,"current");removeClass(btn.randomPlay,"current");me.playMode=3});var $progress=this.musicDom["curProcess"].parentNode;$progress.addEventListener("click",function(e){e=e||window.event;var left=this.getBoundingClientRect().left,width=this.offsetWidth;var progressX=Math.min(width,Math.abs(e.clientX-left));if(me.audioDom.currentTime&&me.audioDom.duration){me.audioDom.currentTime=parseInt((progressX/width)*(me.audioDom.duration));me.play()}})},getLyric:function(index){if(this.lyricCache[index]){this.renderLyric(this.lyricCache[index])}else{var url=this.musicList[index]["lyric"],me=this;if(url){ajax(url,function(data){me.lyricCache[index]=data?data:null;me.renderLyric(data)})}else{this.lyricCache[index]=null;me.renderLyric(null)}}},parseLyric:function(lyric){if(!lyric){return lyric}var result=[];var cArr=lyric.split("[");cArr.shift();for(var i=0;i<cArr.length;i++){var o=cArr[i].split("]");if(o.length>=2&&o[1]!=""){var tArr=o[0].split(":"),t=0;if(tArr.length>=2){var mtArr=tArr[0].split(""),mt=0;for(var k=0;k<mtArr.length;k++){if(Number(mtArr[k])>0){mt+=mtArr[k]*Math.pow(10,mtArr.length-k-1)}}t+=mt*60;var stArr=tArr[1].split("."),intStArr=stArr[0].split(""),st=0;
        for(var j=0;j<intStArr.length;j++){if(Number(intStArr[j])>0){st+=intStArr[j]*Math.pow(10,intStArr.length-j-1)}}t+=Number(st+"."+stArr[1])}if(t&&typeof t=="number"){result.push({time:parseInt(t*1000),content:o[1]})}}}return result},renderLyric:function(lyric){lyric=this.parseLyric(lyric);var me=this,dom=me.musicDom["lyricWrap"],tpl="",len,i=0;len=lyric?lyric.length:0;if(lyric&&len){for(i;i<len;i++){var data=lyric[i];var time=data["time"],text=data["content"].trim();text=text?text:"--- music ---";tpl+='<li class="u-lyric f-toe" data-time="'+time+'">'+text+"</li>"}tpl&&(tpl+='<li class="u-lyric">www.29fh.com</li>')}else{tpl='<li class="eof">暂无歌词...</li>'}dom.style.marginTop=0+"px";dom.screenTop=0;dom.innerHTML=tpl},init:function(){this.musicDom={music:$(".grid-music-container"),cover:$(".grid-music-container .u-cover"),title:$(".grid-music-container .u-music-title"),curProcess:$(".grid-music-container .current-process"),bufferProcess:$(".grid-music-container .buffer-process"),time:$(".grid-music-container .u-time"),listWrap:$(".grid-music-container .m-music-list-wrap"),lyricWrap:$(".grid-music-container .js-music-lyric-content"),volume:{volumeProcess:$(".grid-music-container .volume-process"),volumeCurrent:$(".grid-music-container .volume-current"),volumeCtrlBar:$(".grid-music-container .volume-bar"),volumeEventer:$(".grid-music-container .volume-event"),volumeControl:$(".grid-music-container .volume-control")},button:{ctrl:$(".grid-music-container .ctrl-play"),prev:$(".grid-music-container .prev"),next:$(".grid-music-container .next"),listCircular:$(".grid-music-container .mode-list"),randomPlay:$(".grid-music-container .mode-random"),singleCircular:$(".grid-music-container .mode-single")}};this.currentMusic=this.config.defaultIndex||0;this.playMode=this.config.defaultMode||1;this.lyricCache={};this.audioDom=document.createElement("audio");this.createListDom();this.initPlay();this.action()}};win=win||window;win.SMusic=function(options){return new SmohanMusic(options)}})(window);