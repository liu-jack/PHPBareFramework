{:view('Public/header')}

<script type="text/javascript" src="{JS_PATH}DatePicker/WdatePicker.js"></script>

<!-- Main content starts -->
<div class="content">
    <div class="matter">

        <div class="widget">
            <div class="widget-head">
                <div class="pull-left">推送管理</div>
                <div class="clearfix"></div>
            </div>
            <div class="widget-content">
                <br/>
                <ul class="nav nav-tabs iframe-nav">
                    <li class="active"><a href="#public" data-toggle="tab">公用消息推送</a></li>
                    <li><a href="#tag" data-toggle="tab">按用户类型推送</a></li>
                    <li><a href="#personal" data-toggle="tab">个人消息推送</a></li>
                </ul>
                <br/>
                <div class="tab-content">
                    <div id="public" class="tab-pane active">
                        <form method="post" id="public-form">
                            <table class="table table-striped table-bordered" align="center">
                                <tr>
                                    <th colspan="2">推送消息管理</th>
                                </tr>
                                <tr>
                                    <td width="15%">推送消息类型</td>
                                    <td>
                                        <label>
                                            <select name="type" class="form-control" style="width: 200px">
                                                <option value="0">==选择推送消息类型==</option>
                                                {foreach ($types as $v)}
                                                <option value="{$v['TypeId']}">{$v['TypeName']}</option>
                                                {/foreach}
                                            </select>
                                        </label>
                                    </td>
                                </tr>
                                <tr>
                                    <td>推送平台</td>
                                    <td>
                                        {foreach ($system as $k => $v)}
                                        <label class="checkbox-inline">
                                            <input type="checkbox" name="appid[]" value="{$v['AppId']}"
                                                   checked="checked"/> {$v['AppName']}
                                        </label>
                                        {/foreach}
                                    </td>
                                </tr>
                                <tr>
                                    <td>推送消息</td>
                                    <td><label><input class="form-control span6" type="text" name="msg" style="width: 80%"/></label></td>
                                </tr>
                                <tr class="input_data">
                                    <td>数据</td>
                                    <td>
                                        <label><input class="form-control span6" type="text" name="data" style="width: 80%"/></label>
                                        <br/>
                                        [推送纯消息 -> 此字段留空]<br/>
                                        [推送URL -> 填写URL]<br/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td>
                                        <input type="button" class="btn btn-danger" id="public-submit" value="提交"/>
                                        请谨慎填写，这里的内容不可撤销，一旦提交就会影响数所有用户
                                    </td>
                                </tr>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td>
                                        <label><input type="text" class="form-control span6" name="settime" onFocus="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm',minDate:'%y-%M-%d %H:#{%m+5}}'});" value="" readonly/></label> &nbsp;
                                        <input type="button" class="btn btn-danger" id="settime-push" value="定时推送"/>
                                    </td>
                                </tr>
                            </table>
                        </form>
                    </div>

                    <div id="tag" class="tab-pane">
                        <form method="post" id="tag-form">
                            <table class="table table-striped table-bordered" align="center">
                                <tr>
                                    <th colspan="2">推送消息管理</th>
                                </tr>
                                <tr>
                                    <td width="15%">推送消息类型</td>
                                    <td>
                                        <label>
                                            <select name="type" class="form-control" style="width: 200px">
                                                <option value="0">==选择推送消息类型==</option>
                                                {foreach ($types as $v)}
                                                <option value="{$v['TypeId']}">{$v['TypeName']}</option>
                                                {/foreach}
                                            </select>
                                        </label>
                                    </td>
                                </tr>
                                <tr>
                                    <td>推送平台</td>
                                    <td>
                                        {foreach ($system as $k => $v)}
                                        <label class="checkbox-inline">
                                            <input type="checkbox" name="appid[]" value="{$v['AppId']}" checked="checked"/> {$v['AppName']}
                                        </label>
                                        {/foreach}
                                    </td>
                                </tr>
                                <tr>
                                    <td>用户类型</td>
                                    <td>
                                        <label class="checkbox-inline">
                                            <input type="checkbox" name="tag[]" value="STAGE0" /> 未登录
                                        </label>
                                        <label class="checkbox-inline">
                                            <input type="checkbox" name="tag[]" value="STAGE1" /> 已登录
                                        </label>
                                    </td>
                                </tr>
                                <tr>
                                    <td>推送消息</td>
                                    <td><label><input class="form-control span6" type="text" name="msg" style="width: 80%"/></label></td>
                                </tr>
                                <tr class="input_data">
                                    <td>数据</td>
                                    <td>
                                        <label><input class="form-control span6" type="text" name="data" style="width: 80%"/></label>
                                        <br/>
                                        [推送纯消息 -> 此字段留空]<br/>
                                        [推送URL -> 填写URL]<br/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td>
                                        <input type="button" class="btn btn-danger" id="tag-submit" value="提交"/>
                                        请谨慎填写，这里的内容不可撤销，一旦提交就会影响数所选用户类型的所有用户
                                    </td>
                                </tr>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td>
                                        <label><input type="text" class="form-control span6" name="settime" onFocus="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm',minDate:'%y-%M-%d %H:#{%m+5}}'});" value="" readonly/></label>  &nbsp;
                                        <input type="button" class="btn btn-danger" id="settime-tag-push" value="定时推送"/>
                                    </td>
                                </tr>
                            </table>
                        </form>
                    </div>

                    <div class="tab-pane fade" id="personal">
                        <form method="post" id="personal-form">
                            <table class="table table-striped table-bordered" align="center">
                                <tr>
                                    <th colspan="2">推送消息管理</th>
                                </tr>
                                <tr>
                                    <td>推送平台</td>
                                    <td>
                                        <label>
                                            <select class="form-control input-medium" name="appid" id="persional-where"
                                                    style="width: 200px">
                                                {foreach ($system as $k => $v)}
                                                <option value="{$v['AppId']}">{$v['AppName']}</option>
                                                {/foreach}
                                            </select>
                                        </label>
                                    </td>
                                </tr>
                                <tr>
                                    <td width="15%">推送消息类型</td>
                                    <td>
                                        <label>
                                            <select class="form-control" name="type" style="width: 200px">
                                                <option value="0">==选择推送消息类型==</option>
                                                {foreach ($types as $k => $v)}
                                                <option value="{$v['TypeId']}">{$v['TypeName']}</option>
                                                {/foreach}
                                            </select>
                                        </label>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        用户识别标识
                                    </td>
                                    <td>
                                        <input class="form-control input-xlarge" type="text" name="token" style="width: 80%"
                                               placeholder="个推推送ID"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        用户ID<br/>
                                        用户识别标识与用户ID二选一，都填写了时以用户识别标识为准
                                    </td>
                                    <td>
                                        <input class="form-control input-xlarge" type="text" name="uid" style="width: 80%"
                                               placeholder="个推用户ID"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>推送消息</td>
                                    <td><label><input class="form-control span6" type="text" name="msg" style="width: 80%"/></label></td>
                                </tr>
                                <tr class="input_data">
                                    <td>数据</td>
                                    <td>
                                        <label><input class="form-control span6" type="text" name="data" style="width: 80%"/></label>
                                        <br/>
                                        [推送纯消息 -> 此字段留空]<br/>
                                        [推送URL -> 填写URL]<br/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>&nbsp;</td>
                                    <td>
                                        <input type="button" class="btn btn-danger" id="personal-submit" value="提交"/>
                                        请谨慎填写，一但推送不可取消！
                                    </td>
                                </tr>
                            </table>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <!-- Matter ends -->
    <div class="clearfix"></div>
</div>
<!-- Content ends -->
<script type="text/javascript">
    function show_down(main) {
        var cur = main.find("select[name=type]");
        cur.change(function () {
            var input_data = main.find('.input_data');
            if (cur.val() == 1) {
                input_data.find('input').val('');
                input_data.hide();
            } else {
                input_data.show();
            }
        });
    }
    show_down($("#public-form"));
    show_down($("#tag-form"));
    show_down($("#personal-form"));

    $("#public-submit").click(function () {
        var that = $(this),
            reset = function () {
                that.prop('disabled', false);
                that.val('提交');
            };
        if ($(this).prop('disabled')) {
            return true;
        }

        $(this).prop('disabled', true);
        $(this).val('推送中...');

        top.swal({
            title: '推送确认',
            text: '请谨慎填写，一旦提交不可撤销!',
            type: "warning",
            showCancelButton: true,
            cancelButtonText: '取消',
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "确定",
            closeOnConfirm: false
        }, function (isConfirm) {
            if (isConfirm) {
                $.ajax({
                    url: "{url('pushAll')}",
                    type: "POST",
                    data: $("#public-form").serialize(),
                    dataType: "json",
                    success: function (json) {
                        if (json.code == 200) {
                            $("#public-form").get(0).reset();
                            top.swal('success', json.msg, 'success');
                        } else {
                            top.swal('error', json.msg, 'error');
                        }
                        reset();
                    }
                });
            } else {
                reset();
            }

        });
    });
    //定时推送
    $("#settime-push").click(function () {
        var that = $(this),
            reset = function () {
                that.prop('disabled', false);
                that.val('定时推送');
            };
        if ($(this).prop('disabled')) {
            return true;
        }

        $(this).prop('disabled', true);
        $(this).val('设置中...');

        top.swal({
            title: '确认定时推送？',
            text: '请谨慎填写!',
            type: "warning",
            showCancelButton: true,
            cancelButtonText: '取消',
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "确定",
            closeOnConfirm: false
        }, function (isConfirm) {
            if (isConfirm) {
                $.ajax({
                    url: "{url('pushTime')}",
                    type: "POST",
                    data: $("#public-form").serialize(),
                    dataType: "json",
                    success: function (json) {
                        if (json.code == 200) {
                            $("#public-form").get(0).reset();
                            top.swal('success', json.msg, 'success');
                        } else {
                            top.swal('error', json.msg, 'error');
                        }
                        reset();
                    }
                });
            } else {
                reset();
            }

        });
    });

    $("#tag-submit").click(function () {
        var that = $(this),
            reset = function () {
                that.prop('disabled', false);
                that.val('提交');
            };
        if ($(this).prop('disabled')) {
            return true;
        }

        $(this).prop('disabled', true);
        $(this).val('推送中...');

        top.swal({
            title: '推送确认',
            text: '请谨慎填写，一旦提交不可撤销!',
            type: "warning",
            showCancelButton: true,
            cancelButtonText: '取消',
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "确定",
            closeOnConfirm: false
        }, function (isConfirm) {
            if (isConfirm) {
                $.ajax({
                    url: "{url('pushTag')}",
                    type: "POST",
                    data: $("#tag-form").serialize(),
                    dataType: "json",
                    success: function (json) {
                        if (json.code == 200) {
                            $("#tag-form").get(0).reset();
                            top.swal('success', json.msg, 'success');
                        } else {
                            top.swal('error', json.msg, 'error');
                        }
                        reset();
                    }
                });
            } else {
                reset();
            }

        });
    });
    //定时推送
    $("#settime-tag-push").click(function () {
        var that = $(this),
            reset = function () {
                that.prop('disabled', false);
                that.val('定时推送');
            };
        if ($(this).prop('disabled')) {
            return true;
        }

        $(this).prop('disabled', true);
        $(this).val('设置中...');

        top.swal({
            title: '确认定时推送？',
            text: '请谨慎填写!',
            type: "warning",
            showCancelButton: true,
            cancelButtonText: '取消',
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "确定",
            closeOnConfirm: false
        }, function (isConfirm) {
            if (isConfirm) {
                $.ajax({
                    url: "{url('pushTime')}",
                    type: "POST",
                    data: $("#tag-form").serialize(),
                    dataType: "json",
                    success: function (json) {
                        if (json.code == 200) {
                            $("#tag-form").get(0).reset();
                            top.swal('success', json.msg, 'success');
                        } else {
                            top.swal('error', json.msg, 'error');
                        }
                        reset();
                    }
                });
            } else {
                reset();
            }

        });
    });

    $("#personal-submit").click(function () {
        var that = $(this),
            reset = function () {
                that.prop('disabled', false);
                that.val('提交');
            };
        if ($(this).prop('disabled')) {
            return true;
        }

        $(this).prop('disabled', true);
        $(this).val('推送中...');

        top.swal({
            title: '推送确认',
            text: '请谨慎填写，一旦提交不可撤销!',
            type: "warning",
            showCancelButton: true,
            cancelButtonText: '取消',
            confirmButtonColor: "#DD6B55",
            confirmButtonText: "确定",
            closeOnConfirm: false
        }, function (isConfirm) {
            if (isConfirm) {
                $.ajax({
                    url: "{url('pushPerson')}",
                    type: "POST",
                    data: $("#personal-form").serialize(),
                    dataType: "json",
                    success: function (json) {
                        if (json.code == 200) {
                            $("#personal-form").get(0).reset();
                            top.swal('success', json.msg, 'success');
                        } else {
                            top.swal('error', json.msg, 'error');
                        }
                        reset();
                    }
                });
            } else {
                reset();
            }
        });
    });
</script>

{@view('Public/footer')}